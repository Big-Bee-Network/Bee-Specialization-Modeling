---
title: "BeeModeling"
author: "Nick R. Bachelder"
date: "5/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/colleen/Dropbox/Fall_2014/ucsb/Bee-Specialization-Modeling/")
knitr::opts_knit$set(error=T)
select = dplyr::select

library(lifecycle)
library(rvest)
library(dplyr)
library(plotly)
library(tidyverse)
library(data.table)
library(readxl)
library(Taxonstand)
library(vroom)


```

```{r, echo = False}
options(max.print=1000000)
interactions_b <- vroom('modeling_data/interactions_dup.csv')
fowler <- read_csv("modeling_data/fowler_hostplants.csv") 

for (c in colnames(interactions_b)) {
  interactions_b[[c]] <-  tolower(interactions_b[[c]])
}


```




```{r}
interactions_b[1:5,1:5]
```

Let's reformat and update the plant names in the interaction data 
```{r}
capitalize = function(a_string){
  
  beginning = toupper(substr(a_string,1,1))
  ending = substr(a_string,2,nchar(a_string))
  
  return(paste0(beginning,ending))

}

interactions_reformat = interactions_b %>% 
  mutate(scientificName = capitalize(sourceTaxonSpeciesName), 
         bee_family = capitalize(sourceTaxonFamilyName),
         plant_family = capitalize(targetTaxonFamilyName), 
         plant_genus = capitalize(targetTaxonGenusName),
         plant_species = capitalize(targetTaxonName)) %>%
  filter(scientificName != '' & plant_family !='' & plant_genus != "")%>%
   filter(!targetTaxonRank %in% c('species',"genus"))

#
str(interactions_reformat)

plant_df = interactions_reformat %>%
  distinct(plant_species)
test_me = plant_df$plant_species

# check_names = TPL(test_me) #takes forever to run, download output as csv
# write_csv(check_names,'modeling_data/plant_list_name_update.csv')
check_names = read_csv('modeling_data/plant_list_name_update.csv')


check_names %>% filter(Taxonomic.status != 'Accepted') %>% 
  select(Taxon,New.Genus,New.Species)

tpl_formatted = check_names %>% 
  rename(plant_species = Taxon) %>% 
  mutate(accepted_name = ifelse(!is.na(New.Species),paste(New.Genus,New.Species),New.Genus) ) %>%
  mutate(accepted_name = ifelse(is.na(accepted_name), plant_species, accepted_name)) %>%
  select(plant_species,accepted_name)

tpl_formatted %>% filter(is.na(accepted_name))

#add accepted_name column to plant_df
interactions_updated = interactions_reformat %>% 
  group_by(scientificName,bee_family,plant_species,plant_family) %>%
  summarize(n=n(),n_source_citations = n_distinct(sourceCitation),n_ref_citations = n_distinct(referenceCitation)) %>%
  ungroup %>%
  left_join(tpl_formatted) %>%
  select(-plant_species) %>%
  rename(plant_species = accepted_name) %>%
  mutate(plant_genus = sub(" .*","",plant_species))%>%
  mutate(plant_genus = ifelse(plant_genus == "Ipomaea","Ipomoea",plant_genus))

head(interactions_updated)


#let's also reformat so that the data re not grouped (each row a unique record)
nrow(interactions_reformat %>% left_join(tpl_formatted)) == nrow(interactions_reformat)

str(interactions_reformat)
globi_names = colnames(interactions_reformat)
globi_names[grepl('Sex',globi_names)]

each_interaction = interactions_reformat %>% 
  select(scientificName,bee_family,plant_species,plant_family,interactionTypeName,sourceTaxonRank, targetTaxonRank,referenceCitation,sourceCitation,decimalLongitude,decimalLatitude,sourceSexId,sourceSexName,targetSexId,targetSexName) %>%
  left_join(tpl_formatted) %>%
  select(-plant_species) %>%
  rename(plant_species = accepted_name) %>%
  mutate(plant_genus = sub(" .*","",plant_species))%>%
  mutate(plant_genus = ifelse(plant_genus == "Ipomaea","Ipomoea",plant_genus))


interactions_updated %>%
  select(scientificName,n,n_source_citations,n_ref_citations,plant_species) %>%
  filter(n>5)

# write_csv(interactions_reformat %>% filter(scientificName == "Agapostemon angelicus" & plant_species =="Helianthus annuus") %>% distinct(sourceCitation,referenceCitation),'look_at_refs.csv')

# write_csv(interactions_updated,'modeling_data/globi_names_updated.csv')
# write_csv(each_interaction,'modeling_data/globi_occ_names_updated.csv')
```

Let's do some reformatting
```{r}

globi_summ = interactions_updated %>%
  group_by(scientificName, plant_genus, plant_family,bee_family) %>%
  summarize(n_genus = sum(n),genus_source_citations=sum(n_source_citations)) %>% #this treats interactions of different plant species within the same genus as separate citations
  ungroup()


```

how many specialist bees do we have if we filter out interactions with <5 observations?
```{r}
globi_5n = globi_summ %>% filter(n_genus >= 5)
n_distinct(globi_5n$scientificName[globi_5n$scientificName %in% ms_specialists$scientificName]) #only 360

#how many other species
n_distinct(globi_5n$scientificName[!globi_5n$scientificName %in% ms_specialists$scientificName]) # 730, so about 1000 total


```
Calculate number of interaction partners

```{r}

#calculate the number of plant families each bee species is observed visiting
total_obs = globi_summ %>% group_by(scientificName) %>% summarize(n=sum(n_genus))

# degree_by_fam 
degree_by_fam = globi_summ %>% group_by(scientificName,plant_family) %>%
  summarize(n_family = sum(n_genus),n_source_citations=sum(genus_source_citations)) %>% # %>%this treats genera within the same fam, from the same source as separate sources
  left_join(total_obs) %>%
  mutate(freq_squared = (n_family/n)^2) %>% 
  group_by(scientificName,n) #%>%
  summarize(degree_family = n_distinct(plant_family), 
            degree5_family = sum(n_family >= 5), weighted_degree_fam = sum(freq_squared),
            simpson_family_citations=sum(n_source_citations),simpson())
 

#calculate the number of plant genera each bee species is observed visiting
degree_by_genus = globi_summ %>%
  left_join(total_obs) %>%
  mutate(freq_squared = (n_genus/n)^2) %>% 
  group_by(scientificName,bee_family) %>%
  summarize(degree_genus = n_distinct(plant_genus), 
            degree5_genus = sum(n_genus >= 5), weighted_degree_genus = sum(freq_squared)) 

           
globi_degree = degree_by_fam %>% left_join(degree_by_genus) %>%
  mutate(diet_breadth = ifelse(scientificName %in% specialists,'specialist','generalist'))
# write_csv(globi_degree,'modelign_data/globi_degree.csv')

```
