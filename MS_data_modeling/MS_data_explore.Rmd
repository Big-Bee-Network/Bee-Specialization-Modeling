---
title: "MS_data_clean"
author: "Nick R. Bachelder"
date: "10/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lifecycle)
library(rvest)
library(dplyr)
library(tidyr)
library(plotly)
library(dplyr)
library(data.table)
library(stringr)
library(readxl)
library(kableExtra)
library(rcol)
library(plyr)
library(caret)

MS_data <- readxl::read_xlsx('/Users/nickbachelder/Desktop/UCSB Archive/Fall 2021/Data for Bees/DATA_pollen-diet-breadth_list_12-5-21_ALR.xlsx', sheet = 2)


globee <- read.csv('/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/Fowler-GLOBI Modeling/BeeCiteRaw') %>%
  dplyr::select(-west_specialist, -east_specialist, -cent_specialist, -specialist)

globee_5cut <- read.csv('/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/Fowler-GLOBI Modeling/BeeCiteC5') %>%
  dplyr::select(-west_specialist, -east_specialist, -cent_specialist, -specialist)

globee_T <- read.csv('/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/Fowler-GLOBI Modeling/BeeCiteW') %>%
  dplyr::select(-west_specialist, -east_specialist, -cent_specialist, -specialist)

fowler <- read.csv('/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/Fowler-GLOBI Modeling/fowler') %>%
   mutate(interestBee = str_to_title(interestBee)) %>%
  dplyr::select(interestBee, west_specialist, east_specialist, cent_specialist, specialist, Status_E, Status_W, Status_C) %>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))

globeeGenus <- read.csv('/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/Fowler-GLOBI Modeling/BeeCiteRawGenus') %>%
  dplyr::select(-west_specialist, -east_specialist, -cent_specialist, -specialist)

globee_5cutGenus <- read.csv('/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/Fowler-GLOBI Modeling/BeeCiteC5Genus') %>%
  dplyr::select(-west_specialist, -east_specialist, -cent_specialist, -specialist)

globee_TGenus <- read.csv('/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/Fowler-GLOBI Modeling/BeeCiteWGenus') %>%
  dplyr::select(-west_specialist, -east_specialist, -cent_specialist, -specialist)
```

```{r}
interactions <- read.csv('/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/interactions_dup.csv')

(interactions %>% filter(targetTaxonRank == 'family') %>% dplyr::select(sourceTaxonName, interactionTypeName, targetTaxonName) %>% 
    dplyr::rename('Bee Species' = sourceTaxonName, 'Interaction' = interactionTypeName, 'Plant Family' = targetTaxonName))[c(172, 112, 300, 124 ,5),]  %>%
  kbl() %>% kable_styling()
       
```



```{r}
MS_data_format <- MS_data %>% mutate(interestBee = str_to_title(paste(Genus, sub(".*? ", "", Species)))) %>% 
  dplyr::rename(degreeMS = 'Pollen host family #', degreeMSGenus = 'Pollen host genus #', specializationMS = 'Redefined pollen diet breadth', pollenHosts = 'Pollen hosts') %>%
  dplyr::select(interestBee, pollenHosts, degreeMS, degreeMSGenus, specializationMS, References) %>%
  filter(!is.na(specializationMS)) %>% arrange(interestBee) %>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))

MS_data_format <- MS_data_format %>% filter(!(is.na(specializationMS)), !is.na(pollenHosts)) ### there

MS_data_format
```


### create family level column by pulling

```{r}
cp_nu_search(q='Helianthus', status = "accepted")$result$classification
```



```{r}
MS_data_format$pollenHosts <-  gsub("\\?.*", "", MS_data_format$pollenHosts)
MS_data_format$pollenHosts <-  gsub("\\..*", "", MS_data_format$pollenHosts)
 
ms_pollen_hosts = na.omit(unique(
  
  sub("\\/.*", "", word(unlist(str_split(unique(MS_data_format$pollenHosts), pattern = ', ')), 1))
  
  ))

## pulls all unique maximum level taxonomic names from MS pollen hosts
ms_pollen_hosts <- ms_pollen_hosts[!(ms_pollen_hosts == '')]
```



```{r}
library(rcol)
library(pbapply)

find_family <- function(name) {
  try <- try(cp_nu_search(q=name, status = "accepted"), silent=TRUE)
  if ("try-error" %in% class(try)) {
    label <- 'Unknown'
  }
  try <- try(str_to_title(tolower(
    (rbind( data.frame(try$result$classification[1]),
        data.frame(try$result$classification[2]),
       data.frame(try$result$classification[3])) %>% filter(rank == 'family'))[1,]$label
    )), silent=TRUE)
  if ("try-error" %in% class(try)) {
    label <- 'Unknown'
  }
  else {
    label <- try
  }
  return(label)
}

familys <- pblapply(ms_pollen_hosts, find_family)
```


```{r}
familys <- unlist(familys)
family_key <- data.frame(cbind(ms_pollen_hosts, familys)) %>% `colnames<-`(c('max_taxons', 'pollen_host_familys')) 

family_key
```

## Make the below two entries have 0 rows with Avery's help
```{r}
family_key %>% filter(is.na(pollen_host_familys) | (pollen_host_familys == 'NA'))
```

```{r}
family_key %>% filter(pollen_host_familys == 'Unknown', grepl( ',', max_taxons, fixed = TRUE))
```



## make sure the below has no family name synonyms. Take out the unknownand NA values until we fix them with avery.

```{r}
pollen_family_MS <- MS_data_format %>% select(interestBee, pollenHosts) %>% separate_rows(pollenHosts, sep=', ') %>% mutate(max_taxons = word(pollenHosts, 1)  ) %>% left_join(family_key, by = 'max_taxons') %>% select(interestBee, pollen_host_familys) %>% 
  group_by(interestBee) %>% 
  dplyr::summarise(pollen_host_familys = paste(unique(as.vector(pollen_host_familys)), collapse = ', '))


MS_data_format <- MS_data_format %>% left_join(pollen_family_MS, by = 'interestBee') 
``` 


### Note, NAs are a result of there being no pollen hsots listed for a bee (should be fixed by filtering out bees with no pollen hosts), and Unknowns are a results of bees not being able to be found in catalougue of life

```{r}
avery_send <- MS_data_format %>% select(interestBee, pollenHosts, pollen_host_familys) %>% mutate(ifelse(pollen_host_familys == 'NA', NA, pollen_host_familys))

write.csv(avery_send, "/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/Family_Level_Transform.csv")

avery_send
``` 


### Clean GLOBEE data


```{r}
pollenHostGLOBEE <- aggregate(interactFamily~interestBee, globee_5cut, FUN=toString) %>% mutate(interestBee = str_to_title(interestBee)) %>% 
  dplyr::rename('pollenHostGLOBEEFamily' = interactFamily) %>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))
## this is plant interactions for each bee genus according to globi

pollenHostGLOBEEGenus <- aggregate(interactGenus~interestBee, globee_5cutGenus, FUN=toString) %>% mutate(interestBee = str_to_title(interestBee)) %>% 
  dplyr::rename('pollenHostGLOBEEGenus' = interactGenus) %>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))
## this is plant interactions for each bee genus according to globi

globee_format <- globee %>% mutate(interestBee = str_to_title(interestBee)) %>% dplyr::rename(degreeGLOBEEFamily = degreeFamily) %>% 
  dplyr::select(interestBee, degreeGLOBEEFamily, number_of_citation_for_bee_species) %>% unique() %>%
  arrange(interestBee) %>% merge(pollenHostGLOBEE, by = 'interestBee') %>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))

globee_5cut_format <- globee_5cut %>% mutate(interestBee = str_to_title(interestBee)) %>% dplyr::rename(degreeGLOBEE_C5Family = degreeC5Family) %>% 
  dplyr::select(interestBee, degreeGLOBEE_C5Family) %>% unique() %>%
  arrange(interestBee)%>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))

globee_T_format <- globee_T %>% mutate(interestBee = str_to_title(interestBee)) %>% dplyr::rename(degreeGLOBEE_TFamily = degreeWFamily) %>% 
  dplyr::select(interestBee, degreeGLOBEE_TFamily) %>% unique() %>%
  arrange(interestBee)%>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))

globee_formatGenus <- globeeGenus %>% mutate(interestBee = str_to_title(interestBee)) %>% dplyr::rename(degreeGLOBEEGenus = degreeGenus) %>% 
  dplyr::select(interestBee, degreeGLOBEEGenus, number_of_citation_for_bee_species) %>% unique() %>%
  arrange(interestBee) %>% merge(pollenHostGLOBEEGenus, by = 'interestBee') %>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))

globee_5cut_formatGenus <- globee_5cutGenus %>% mutate(interestBee = str_to_title(interestBee)) %>% dplyr::rename(degreeGLOBEE_C5Genus = degreeC5Genus) %>% 
  dplyr::select(interestBee, degreeGLOBEE_C5Genus) %>% unique() %>%
  arrange(interestBee)%>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))

globee_T_formatGenus <- globee_TGenus %>% mutate(interestBee = str_to_title(interestBee)) %>% dplyr::rename(degreeGLOBEE_TGenus = degreeWGenus) %>% 
  dplyr::select(interestBee, degreeGLOBEE_TGenus) %>% unique() %>%
  arrange(interestBee)%>% 
  filter(grepl('^\\w+\\s\\w+$', interestBee))

globee_formatGenus %>% filter(interestBee == 'Andrena Accepta')
globee_5cut_formatGenus %>% filter(interestBee == 'Andrena Accepta')
```


```{r}
compare_df <- merge(globee_format, MS_data_format, by = c('interestBee'), type = 'all')  
compare_df <- merge(compare_df, globee_5cut_format, by = c('interestBee'), type = 'all') 
compare_df <- merge(compare_df, globee_T_format, by = c('interestBee'), type = 'all') 
compare_df <- merge(compare_df, globee_formatGenus, by = c('interestBee', 'number_of_citation_for_bee_species'), type = 'all') 
compare_df <- merge(compare_df, globee_5cut_formatGenus, by = c('interestBee'), type = 'all') 
compare_df <- merge(compare_df, globee_T_formatGenus, by = c('interestBee'), type = 'all') 

compare_df <- compare_df %>% merge(fowler %>% dplyr::rename(specialistFOWLER = specialist) %>% 
                                     dplyr::select(interestBee, specialistFOWLER, Status_E, Status_W, Status_C), by = c('interestBee'), all = T) %>% unique() %>%
  mutate(existsGLOBEE = ifelse(is.na(degreeGLOBEEFamily), 0, 1), existsMS = ifelse(is.na(specializationMS), 0, 1), 
         existsFOWLER = ifelse(is.na(specialistFOWLER), 0, 1),
         existsALL = existsGLOBEE*existsMS) %>%
  mutate(specialistFOWLER = ifelse(is.na(specialistFOWLER), 0 , specialistFOWLER))%>%
  dplyr::rename(pollenHostsMS = pollenHosts , pollenHostsFamilysMS = pollen_host_familys,ReferencesMS = References) %>%
  rowwise() %>%
  dplyr::mutate(pollenHostsFamilysMS = ifelse(pollenHostsFamilysMS == 'NA', NA, pollenHostsFamilysMS) ) %>%
  dplyr::mutate(FamilyDegreeMS = ifelse(!is.na(pollenHostsFamilysMS), length(strsplit(pollenHostsFamilysMS, split = ', ')[[1]]), 0  ) )

compare_df %>% filter(existsMS == 1, existsGLOBEE == 1) %>% dplyr::select(interestBee, degreeGLOBEEGenus, degreeGLOBEE_C5Genus) %>%
  filter(!is.na(degreeGLOBEE_C5Genus), is.na(degreeGLOBEEGenus))

final <- compare_df %>% filter(existsMS == 1, existsGLOBEE == 1) %>% 
  dplyr::rename(interest_bee_species = interestBee, number_of_citations_for_bee_species_GloBi = number_of_citation_for_bee_species, degree_raw_GloBi_family = degreeGLOBEEFamily,
                visitation_hosts_GloBi_family = pollenHostGLOBEEFamily, pollen_host_genus_MS = pollenHostsMS, degree_MS_family = degreeMS, degree_MS_Genus = degreeMSGenus,
                specialization_MS = specializationMS, References_MS = ReferencesMS, pollen_host_family_MS = pollenHostsFamilysMS, 
                degree_cut_5_GloBi_family = degreeGLOBEE_C5Family, degree_transformed_GloBi_family = degreeGLOBEE_TFamily, 
                degree_raw_GloBi_genus = degreeGLOBEEGenus, visitation_hosts_GloBi_genus = pollenHostGLOBEEGenus, degree_cut_5_GloBi_genus = degreeGLOBEE_C5Genus,
                degree_transformed_GloBi_genus = degreeGLOBEE_TGenus, rarity_east_fowler = Status_E, rarity_central_fowler = Status_C, rarity_west_fowler = Status_W,
                degree_MS_genus = degreeMSGenus) %>% 
  dplyr::select(interest_bee_species, number_of_citations_for_bee_species_GloBi, degree_raw_GloBi_family, degree_cut_5_GloBi_family, degree_transformed_GloBi_family,
                visitation_hosts_GloBi_family, degree_MS_family, pollen_host_family_MS, degree_raw_GloBi_genus, degree_cut_5_GloBi_genus, 
                degree_transformed_GloBi_genus, degree_MS_genus,
                visitation_hosts_GloBi_genus, pollen_host_genus_MS, specialization_MS, rarity_east_fowler, rarity_central_fowler, rarity_west_fowler) %>% 
           mutate(pollen_host_family_MS = str_remove(visitation_hosts_GloBi_family, "NA, "),
                  visitation_hosts_GloBi_family = str_to_title(visitation_hosts_GloBi_family), pollen_host_family_MS =str_to_title(pollen_host_family_MS),
                  visitation_hosts_GloBi_genus = str_to_title(visitation_hosts_GloBi_genus))

final

write.csv(final, '/Users/nickbachelder/Desktop/Bee-Specialization-Modeling/modeling_data/visitation_specialization_df')
```



---------------



















